<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">

<polymer-element name="ivx-simple-authorize" attributes="">
  <template>
    <link rel="stylesheet" href="ivx-simple-authorize.css">

    <!-- non-visual dependencies -->
    <ivx-model id="settingModel" name="setting" storageType="localStorage"></ivx-model>

    <div layout vertical center center-justified fit>
      <div id="outerWrapper" layout horizontal>
        <div>
          <paper-input-decorator label="Administrator-PIN">
            <input is="core-input" type="password" value="{{ pin }}">
          </paper-input-decorator>
        </div>

        <div id="fabWrapper">
          <paper-fab id="fab" icon="done" on-tap="{{ onAuthorize }}"></paper-fab>
        </div>
      </div>

      <paper-toast id="toast"></paper-toast>
    </div>

  </template>
  <script>
    (function () {

      Polymer({
        _pin: '',
        _authorized: false,
        _model: null,

        domReady: function() {
          if (this.$.settingModel.all().length == 0) {
            console.warn('The settings are not initialized, please make sure that all settings are initialized when' +
                         'bootstrapping the app.');
          } else {
            this._model = this.$.settingModel.first();
            this._pin = this._model.attr('pin');
            this._authorized = this._model.attr('authorized');
          }
        },

        _authorizedChanged: function() {
          this._model.attr('authorized', this._authorized);
          this._model.save();
        },

        pinChanged: function() {
          this.$.fab.classList.remove(this.pin == this._pin ? 'incorrect-pin' : 'correct-pin');
          this.$.fab.classList.add(this.pin == this._pin ? 'correct-pin' : 'incorrect-pin');
        },

        onAuthorize: function() {
          var pinCorrect = (this.pin == this._pin);
          if (pinCorrect) {
            this._authorized = true;
            this.fire('authorized');
          }

          this.$.toast.text = pinCorrect ? 'Erfolgreich autorisiert!' : 'PIN ist nicht korrekt.';
          this.$.toast.show();
        }
      });
    })();
  </script>
</polymer-element>
