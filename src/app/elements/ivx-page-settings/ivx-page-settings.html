<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/core-icons/notification-icons.html">
<link rel="import" href="../../bower_components/core-icons/image-icons.html">
<link rel="import" href="../../bower_components/core-menu/core-menu.html">
<link rel="import" href="../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-dropdown/paper-dropdown.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-action-dialog.html">
<link rel="import" href="../../bower_components/paper-fab/paper-fab.html">

<link rel="import" href="../ivx-model/ivx-model.html">
<link rel="import" href="../ivx-settings-controller/ivx-settings-controller.html">
<link rel="import" href="../ivx-simple-authorize/ivx-simple-authorize.html">
<link rel="import" href="../ivx-qtype-text/ivx-qtype-text.html">

<polymer-element name="ivx-page-settings" attributes="">
  <template>
    <link rel="stylesheet" href="ivx-page-settings.css">

    <!-- non-visual dependencies -->
    <ivx-model id="settingModel" name="setting" storageType="localStorage"></ivx-model>
    <ivx-settings-controller id="settingsController"></ivx-settings-controller>

    <template if="{{ !_authorized }}">
      <ivx-simple-authorize on-authorized="{{ onAuthorized }}"></ivx-simple-authorize>
    </template>

    <template if="{{ _authorized }}">

      <div class="sectionWrapper">
        <div class="headline">Grundeinstellungen</div>
        <div class="divider"></div>
      </div>

      <div class="listWrapper" layout vertical center>
        <div class="entry" layout horizontal>
          <core-icon icon="notification:vibration"></core-icon>
          <div class="textWrapper">
            <div class="title">Vibrationen</div>
            <div class="descr">Aktiviert die Web Vibration API bei Touchgesten</div>
          </div>
          <div class="actionWrapper">
            <paper-checkbox id="vibrationEnable" on-tap="{{ onVibrationToggle }}" checked?="{{ _vibration.active }}"></paper-checkbox>
          </div>
        </div>
      </div>

      <div class="listWrapper" layout vertical center>
        <div class="entry" layout horizontal>
          <div class="textWrapper indented {{ _vibration.active ? 'active' : 'inactive' }}">
            <div class="title">Kurz</div>
            <div class="descr">Die Vibration wird für {{ _shortVibrate }}ms ausgeführt</div>
          </div>
          <div class="actionWrapper">
            <paper-checkbox
              id="vibrationShort"
              disabled?="{{ !_vibration.active }}"
              on-tap="{{ onVibrationShortToggle }}"
              checked?="{{ _vibration.short }}">
            </paper-checkbox>
          </div>
        </div>
      </div>

      <div class="listWrapper" layout vertical center>
        <div class="entry" layout horizontal>
          <div class="textWrapper indented {{ _vibration.active ? 'active' : 'inactive' }}">
            <div class="title">Lang</div>
            <div class="descr">Die Vibration wird für {{ _longVibrate }}ms ausgeführt</div>
          </div>
          <div class="actionWrapper">
            <paper-checkbox
              id="vibrationLong"
              disabled?="{{ !_vibration.active }}"
              on-tap="{{ onVibrationLongToggle }}"
              checked?="{{ _vibration.long }}">
            </paper-checkbox>
          </div>
        </div>
      </div>

      <div class="sectionWrapper">
        <div class="headline">Darstellung</div>
        <div class="divider"></div>
      </div>

      <div class="listWrapper" layout vertical center>
        <div class="entry" layout horizontal>
          <core-icon icon="image:color-lens"></core-icon>
          <div class="textWrapper">
            <div class="title">Theme</div>
            <div class="descr">Wechselt die Farbdarstellung</div>
          </div>
          <div class="actionWrapper">
            <paper-dropdown-menu label="Theme" on-core-select="{{ onSelectTheme }}">
              <paper-dropdown class="dropdown" halign="right" valign="bottom">
                <core-menu class="menu" selected="{{ _selectedThemeIndex }}">
                  <template repeat="{{ t in _themes }}">
                    <paper-item>[[ t ]]</paper-item>
                  </template>
                </core-menu>
              </paper-dropdown>
            </paper-dropdown-menu>
          </div>
        </div>
      </div>

      <div class="sectionWrapper">
        <div class="headline">Erweiterte Einstellungen</div>
        <div class="divider"></div>
      </div>

      <div class="listWrapper" layout vertical center>
        <div class="entry" layout horizontal>
          <core-icon icon="account-circle"></core-icon>
          <div class="textWrapper">
            <div class="title">PIN</div>
            <div class="descr">Zugriff auf Verwaltungsoptionen</div>
          </div>
          <div class="actionWrapper">
            <paper-button on-tap="{{ onPasswordChange }}">Ändern</paper-button>

            <paper-action-dialog id="passwordDialog" backdrop autoCloseDisabled layered="false">
              <p>Geben Sie zunächst Ihre alte PIN ein und wiederholen Sie die neue PIN zwei Mal.</p>

              <ivx-qtype-text mode="single" required label="Alte PIN" type="password" value="{{ _oldPassword }}"></ivx-qtype-text>
              <ivx-qtype-text mode="single" required label="Neue PIN" type="password" value="{{ _newPassword1 }}"></ivx-qtype-text>
              <ivx-qtype-text mode="single" required label="Neue PIN (Wiederholung)" type="password" value="{{ _newPassword2 }}" pattern="^{{ _newPassword1 }}$" customError="Das Passwort stimmt nicht überein."></ivx-qtype-text>

              <div layout horizontal end-justified>
                <paper-fab mini icon="check" id="dialogBtSave" on-tap="{{ onPasswordDialogSave }}"></paper-fab>
                <paper-fab mini icon="close" id="dialogBtClose" on-tap="{{ onPasswordDialogClose }}"></paper-fab>
              </div>
            </paper-action-dialog>
          </div>
        </div>
      </div>
    </template>

  </template>

  <script>
    (function () {
      'use strict';

      Polymer({
        _model: null,

        // model abstraction variables to use databinding
        _authorized: false,
        _activeTheme: '',
        _vibration: {},

        // ui page variables only
        _oldPassword: '',
        _newPassword1: '',
        _newPassword2: '',
        _selectedThemeIndex: 0,
        _themes: [],

        _shortVibrate: 200,
        _longVibrate: 400,

        observe: {
          '_vibration.active': 'persistVibrationChange',
          '_vibration.short': 'persistVibrationChange',
          '_vibration.long': 'persistVibrationChange'
        },

        domReady: function() {
          this._model = this.$.settingModel.first();
          this._controller = this.$.settingsController;
          this._restoreState();
        },

        _restoreState: function() {
          this._authorized = this._model.attr('authorized');
          this._activeTheme = this._model.attr('activeTheme');
          this._vibration = this._model.attr('vibration');
          this._themes = [
            'Curacao',
            'Ruby'
          ];

          // find out which index is the activeTheme (lowercase saved!)
          this._selectedThemeIndex = this._themes.map(function(val, i) {
            return val.toLowerCase();
          }).indexOf(this._activeTheme);
        },

        onAuthorized: function() {
          this._authorized = true;
        },

        onVibrationToggle: function() {
          this._vibration.active = this.shadowRoot.querySelector('#vibrationEnable').checked;
          if (!this._vibration.active) {
            this._vibration.short = this._vibration.long = false;
          }
        },

        onVibrationShortToggle: function() {
          this._vibration.short = this.shadowRoot.querySelector('#vibrationShort').checked;
          if (this._vibration.short) {
            this._setVibrationDuration(this._shortVibrate);
            this._vibration.long = false;
          }
        },

        onVibrationLongToggle: function() {
          this._vibration.long = this.shadowRoot.querySelector('#vibrationLong').checked;
          if (this._vibration.long) {
            this._setVibrationDuration(this._longVibrate);
            this._vibration.short = false;
          }
        },

        _setVibrationDuration: function(duration) {
          // set duration
          var vibration = this._model.attr('vibration');
          vibration.duration = duration;
          this._model.attr('vibration', vibration);
          this._model.save();

          // vibrate via API
          window.navigator.vibrate(duration);
        },

        persistVibrationChange: function() {
          this._model.attr('vibration', this._vibration).save();

          if (this._model.attr('vibration').active) {
            this._controller.addEventHandler();
          } else {
            this._controller.removeEventHandler();
          }
        },

        onPasswordChange: function() {
          this.shadowRoot.querySelector('#passwordDialog').toggle();
        },

        onPasswordDialogClose: function() {
          this.shadowRoot.querySelector('#passwordDialog').toggle();
        },

        onPasswordDialogSave: function() {
          if (this._model.attr('pin') != this._oldPassword) {
            this.fire('core-signal', { name: 'show-toast', data: 'Die alte PIN ist nicht korrekt.' });
            return;
          }

          if (this._newPassword1 != this._newPassword2) {
            this.fire('core-signal', { name: 'show-toast', data: 'Die beiden eingegebenen PINs stimmen nicht überein.' });
            return;
          }

          if (this._newPassword1 == '') {
            this.fire('core-signal', { name: 'show-toast', data: 'Das neue Passwort darf nicht leer sein.' });
            return;
          }

          this._model.attr('pin', this._newPassword1).save();
          this.shadowRoot.querySelector('#passwordDialog').toggle();
          this.fire('core-signal', { name: 'show-toast', data: 'Die PIN wurde erfolgreich geändert.' });
          this._oldPassword = this._newPassword1 = this._newPassword2 = '';
        },

        onSelectTheme: function(event, detail, sender) {
          var themeName = detail.item.innerText.toLowerCase();
          this._model.attr('activeTheme', themeName).save();
          this._controller.setTheme(themeName);
        }
      });
    })();
  </script>
</polymer-element>
