<!-- 3rd party dependecies -->
<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/core-signals/core-signals.html">

<!-- self-defined elements -->
<link rel="import" href="../ivx-model/ivx-model.html">

<polymer-element name="ivx-settings-controller" attributes="">
  <template>
    <!-- non-visual dependencies -->
    <ivx-model id="settingModel" name="settings" storageType="localStorage"></ivx-model>
    <core-signals on-core-signal-settings-changed="{{ onSettingsModelChanged }}"></core-signals>
  </template>

  <script>
    (function () {
      'use strict';

      var _initialized = false;
      var _currentTheme = '';
      var _model = null;

      var _setTheme = function(themeName) {
        document.querySelector('#themeLink').href = 'styles/theme-' + themeName + '.css';
      };

      var getDefaults = function() {
        var config = {
          pager: {                // custom element / section
            navigation: {         // public attribute
              values: [           // user can choose from
                {'fab': 'Fab'},
                {'bar': 'Bar'}
              ],
              default: 'fab'     // if nothing is set, this is the default
            },
            sort: {
              values: [
                {'none': 'keine'},
                {'asc': 'aufsteigend'},
                {'desc': 'absteigend'}
              ],
              default: 'none'
            }
          },
          app: {
            adminPin: {
              values: 'string',   // value is of type string
              default: '1234'
            },
            authorized: {
              values: 'bool',
              default: false
            },
            theme: {
              values: [
                { 'curacao': 'Curacao' },
                { 'ruby': 'Ruby' }
              ],
              default: 'curacao'
            },
            vibration: {
              values: [
                { 'short': 200 },
                { 'long': 400 }
              ],
              default: 0
            }
          }
        };

        return config;
      };

      var _generateSeedModel = function() {
        var config = getDefaults();

        var modelSeed = {};
        for (var componentName in config) {
          var component = config[componentName];

          for (var attributeName in component) {
            var attribute = component[attributeName];

            if (!modelSeed[componentName]) modelSeed[componentName] = {};
            // set default values for attributes (if array `values` is set)
            if (Array.isArray(attribute.values)) {
              attribute.values.forEach(function (value) {
                modelSeed[componentName][attributeName] = config[componentName][attributeName].default;
              }, this);
            } else {
              modelSeed[componentName][attributeName] = config[componentName][attributeName].default;
            }
          }
        }

        return modelSeed;
      };

      Polymer({
        domReady: function() {
          if (this.$.settingModel.all().length == 0) {
            this.$.settingModel.create(_generateSeedModel()).save();
          }

          if (_model === null) {
            _model = this.$.settingModel.first();
          }
          this._applyConfig();
        },

        _applyConfig: function() {
          if (!_initialized) {
            _initialized = true;
            _setTheme(_model.attributes.app.theme);

            var vibrationActive = _model.attributes.app.vibration != 0;
            if (vibrationActive) {
              this.fire('core-signal', { name: 'config-vibration-enabled', data: { duration: _model.attributes.app.vibration } });
            }
          }
        },

        getConfig: function() {
          return this.$.settingModel.first().attributes;
        },

        getDefaults: function() {
          return getDefaults();
        },

        onSettingsModelChanged: function(event, detail, sender) {
          if (_model) {
            // @todo only save the destination property here and not the whole config!
            _model.attr(detail.config).save();
          }

          // set theme
          if (detail.propName == 'app.theme') {
            if (_currentTheme != detail.propValue) {
              _currentTheme = detail.propValue;
              _setTheme(_currentTheme);
            }
          }

          // do some other stuff here ...
        }
      });
    })();
  </script>
</polymer-element>
