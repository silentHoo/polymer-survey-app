/*  js-model JavaScript library, version 0.7.0
 *  (c) 2010 Ben Pickles
 *
 *  Released under MIT license.
 */
var Model=function(g,e){var f=function(a){this._name=g;this.attributes=a||{};this.callbacks={};this.changes={};this.collection=b;this.errors=[]},b;if(e&&e.collection){b=e.collection;delete e.collection}else b=Model.Collection();f=$.extend(f,b);f.prototype=$.extend({attr:function(a,c){if(arguments.length==2){if(_.isEqual(this.attributes[a],c))delete this.changes[a];else this.changes[a]=c;return this}else if(typeof a=="object"){for(var d in a)this.attr(d,a[d]);return this}else return a in this.changes?
this.changes[a]:this.attributes[a]},bind:function(a,c){this.callbacks[a]=this.callbacks[a]||[];this.callbacks[a].push(c);return this},callPersistMethod:function(a,c){var d=this,h=function(){if(d.collection)if(a=="create")d.collection.add(d);else a=="destroy"&&d.collection.remove(d.id())},j=function(i){if(i){h();d.trigger(a)}var k;if(c)k=c.apply(d,arguments);return k};this.persistence?this.persistence[a](this,j):j.call(this,true)},destroy:function(a){this.callPersistMethod("destroy",a);return this},
id:function(){return this.attributes.id||null},merge:function(a){$.extend(this.attributes,a);return this},newRecord:function(){return this.id()==null},reset:function(){this.changes={};return this},save:function(a){if(!this.valid())return false;this.merge(this.changes).reset();this.callPersistMethod(this.newRecord()?"create":"update",a);return true},trigger:function(a,c){if(a=this.callbacks[a])for(var d=0;d<a.length;d++)a[d].apply(this,c);return this},update:function(a){this.merge(a).trigger("update");
return this},valid:function(){this.errors=[];this.validate();return this.errors.length==0},validate:function(){return this}},e);return f};
Model.Collection=function(g){var e=function(b){this.collection=b||[];this.callbacks={}},f=function(b){return new e(b)};e.prototype=$.extend({add:function(){for(var b=[],a=0;a<arguments.length;a++){var c=arguments[a];if(!this.detect(function(){return this.id()!=null&&this.id()==c.id()})){this.collection.push(c);b.push(c)}}b.length>0&&this.trigger("add",b);return this},all:function(){return this.collection},bind:function(b,a){this.callbacks[b]=this.callbacks[b]||[];this.callbacks[b].push(a);return this},
detect:function(b){return _.detect(this.collection,function(a,c){return b.call(a,c)})||null},each:function(b){$.each(this.collection,function(a){b.call(this,a)});return this},find:function(b){return this.detect(function(){return this.id()==b})},first:function(){return this.collection[0]||null},last:function(){return this.collection[this.collection.length-1]||null},remove:function(b){var a=_.invoke(this.collection,"id");b=_.indexOf(a,b);if(b>-1){this.collection.splice(b,1);this.trigger("remove");return true}else return false},
select:function(b){var a=_.select(this.collection,function(c,d){return b.call(c,d)});return f(a)},sort:function(b){var a=_.sortBy(this.collection,function(c,d){return b.call(c,d)});return f(a)},trigger:function(b,a){if(b=this.callbacks[b])for(var c=0;c<b.length;c++)b[c].apply(this,a);return this}},g);return new e};
Model.RestPersistence=function(g,e){var f=function(){this.resource=g};f.prototype=$.extend({create:function(b,a){return this.xhr("POST",this.create_path(b),b,function(c,d){this.merge(d);a&&a.apply(this,arguments)})},create_path:function(){return this.resource},destroy:function(b,a){return this.xhr("DELETE",this.destroy_path(b),null,a)},destroy_path:function(b){return this.update_path(b)},params:function(b){var a;if(b){var c=_.clone(b.attributes);delete c.id;a={};a[b._name]=c}else a=null;return a},
update:function(b,a){return this.xhr("PUT",this.update_path(b),b,function(c,d){this.merge(d);a&&a.apply(this,arguments)})},update_path:function(b){return[this.resource,b.id()].join("/")},xhr:function(b,a,c,d){return $.ajax({type:b,url:a,dataType:"json",data:this.params(c),failure:function(h,j,i){d&&d.call(c,false,h,i)},success:function(h,j,i){d&&d.call(c,true,h,i)}})}},e);return new f};
